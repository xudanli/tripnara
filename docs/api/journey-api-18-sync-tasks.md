# 行程接口文档 - 18. 同步任务

## 接口信息

**接口路径：** `POST /api/v1/journeys/{journeyId}/tasks/sync`

**接口描述：** 根据目的地/模板重新生成并合并任务

**认证：** 需要 JWT Token（Bearer Token）

**Content-Type：** `application/json`

---

## 路径参数

| 参数名 | 类型 | 必填 | 说明 |
|--------|------|------|------|
| `journeyId` | string | 是 | 行程ID（UUID） |

---

## 请求参数

### 请求体结构

```json
{
  "forceRegenerate": false,
  "templateId": "template-id-123"
}
```

### 字段说明

| 字段名 | 类型 | 必填 | 说明 |
|--------|------|------|------|
| `forceRegenerate` | boolean | 否 | 是否强制重新生成（默认 false） |
| `templateId` | string | 否 | 模板ID（如果要从模板同步任务） |

---

## 请求示例

### cURL

```bash
curl -X POST "http://localhost:3000/api/v1/journeys/04d7126d-219f-49ab-b71a-a595c18d6b8f/tasks/sync" \
  -H "Authorization: Bearer YOUR_JWT_TOKEN" \
  -H "Content-Type: application/json" \
  -d '{
    "forceRegenerate": false,
    "templateId": "template-id-123"
  }'
```

---

## 响应数据

### 成功响应（200 OK）

```json
{
  "success": true,
  "tasks": [
    {
      "id": "task-id-1",
      "title": "确认护照有效期及前往冰岛是否需要签证/入境许可",
      "completed": false,
      "category": "preparation",
      "destination": "冰岛",
      "links": [
        {
          "label": "IATA 入境政策查询",
          "url": "https://www.iatatravelcentre.com/"
        }
      ],
      "autoGenerated": true,
      "createdAt": 1735046400000
    }
  ],
  "message": "同步成功"
}
```

### 响应字段说明

| 字段 | 类型 | 说明 |
|------|------|------|
| `success` | boolean | 是否成功 |
| `tasks` | array | 同步后的任务列表 |
| `tasks[].id` | string | 任务ID |
| `tasks[].title` | string | 任务标题 |
| `tasks[].completed` | boolean | 是否完成 |
| `tasks[].category` | string | 任务类别 |
| `tasks[].destination` | string | 目的地 |
| `tasks[].links` | array | 相关链接列表 |
| `tasks[].autoGenerated` | boolean | 是否自动生成 |
| `tasks[].createdAt` | number | 创建时间（时间戳） |
| `message` | string | 响应消息 |

---

## 错误响应

### 404 Not Found

```json
{
  "statusCode": 404,
  "message": "行程不存在: 04d7126d-219f-49ab-b71a-a595c18d6b8f",
  "error": "Not Found"
}
```

### 403 Forbidden

```json
{
  "statusCode": 403,
  "message": "无权修改此行程",
  "error": "Forbidden"
}
```

---

## 使用示例

### JavaScript/TypeScript

```typescript
const journeyId = '04d7126d-219f-49ab-b71a-a595c18d6b8f';

// 从模板同步任务
const syncData = {
  templateId: 'template-id-123',
  forceRegenerate: false,
};

const response = await fetch(`/api/v1/journeys/${journeyId}/tasks/sync`, {
  method: 'POST',
  headers: {
    Authorization: `Bearer ${token}`,
    'Content-Type': 'application/json',
  },
  body: JSON.stringify(syncData),
});

const result = await response.json();
if (result.success) {
  console.log('同步成功，任务数量:', result.tasks.length);
}
```

---

## 注意事项

1. **任务合并**：
   - 如果指定了 `templateId`，会从模板获取任务
   - 如果 `forceRegenerate` 为 true 或没有任务，会根据目的地生成新任务
   - 新任务会与现有任务合并，基于 `title` 或 `autoKey` 去重

2. **保留用户修改**：
   - 现有任务的完成状态和自定义修改会被保留
   - 只会添加新任务，不会覆盖已存在的任务

3. **权限控制**：只能同步当前登录用户自己的行程任务

4. **AI 生成**：根据目的地生成的任务会标记为 `autoGenerated: true`

