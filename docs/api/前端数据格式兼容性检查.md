# 前端数据格式兼容性检查

## 前端数据结构

```json
{
  "backendItineraryId": "04d7126d-219f-49ab-b71a-a595c18d6b8f",
  "itineraryData": {
    "destination": "冰岛",
    "duration": 5,
    "budget": "medium",
    "preferences": ["nature", "adventure"],
    "travelStyle": "moderate",
    "itinerary": [],
    "recommendations": {...},
    "days": [
      {
        "day": 1,
        "date": "2025-11-24",
        "timeSlots": [
          {
            "time": "09:00",
            "title": "...",
            "activity": "...",
            "type": "attraction",
            "coordinates": { "lat": 64.1419, "lng": -21.9274 },
            "notes": "...",
            "details": {...},
            "cost": 1200,
            "duration": 90
          }
        ]
      }
    ],
    "totalCost": 88400,
    "summary": "...",
    "title": "冰岛之旅"
  }
}
```

## 接口兼容性分析

### 1. ✅ POST /api/itinerary/from-frontend-data (创建行程)

**兼容性：完全兼容**

- ✅ 支持 `itineraryData` 嵌套格式
- ✅ 支持 `itineraryData.days` 数组（包含 `day` 序号、`date`、`timeSlots`）
- ✅ 支持 `itineraryData.preferences` 数组格式（会自动转换为对象）
- ✅ 支持 `itineraryData.destination`, `duration`, `budget`, `travelStyle`
- ✅ 支持 `itineraryData.totalCost`, `summary`, `title`
- ✅ 支持 `itineraryData.recommendations` 对象
- ✅ 支持 `itineraryData.itinerary` 空数组（会被忽略）
- ✅ 支持可选的 `tasks` 字段（虽然当前不保存）
- ✅ 支持可选的 `startDate` 字段

**使用方式：**
```typescript
// 前端发送
POST /api/itinerary/from-frontend-data
{
  "itineraryData": { ... },  // 完整的前端数据
  "startDate": "2025-11-24", // 可选
  "tasks": [...]             // 可选
}
```

**注意：** 这个接口会忽略 `backendItineraryId` 字段，因为它只用于创建新行程。

---

### 2. ⚠️ PATCH /api/itinerary/:id (更新行程)

**兼容性：部分兼容**

**问题：**
- ⚠️ `UpdateItineraryRequestDto` 只支持简单字段更新（destination, startDate, days, summary, totalCost, preferences, status）
- ❌ **不支持更新 `days` 数组的详细内容**（activities/timeSlots）
- ❌ 不支持 `itineraryData` 嵌套格式
- ❌ 不支持更新 `recommendations`、`title` 等字段

**当前支持的更新字段：**
```typescript
{
  destination?: string;
  startDate?: string;
  days?: number;        // 只支持更新天数数量，不支持更新详细内容
  summary?: string;
  totalCost?: number;
  preferences?: {...};
  status?: 'draft' | 'published' | 'archived';
}
```

**建议：** 使用新的接口 `PATCH /api/itinerary/:id/from-frontend-data` 来更新完整数据。

---

### 2.1. ✅ PATCH /api/itinerary/:id/from-frontend-data (从前端数据格式更新行程)

**兼容性：完全兼容** ✨ **新增接口**

- ✅ 支持 `itineraryData` 嵌套格式
- ✅ 支持更新 `itineraryData.days` 数组的详细内容（包括 `day` 序号、`date`、`timeSlots`）
- ✅ 支持更新所有字段（destination, duration, budget, preferences, travelStyle, recommendations, totalCost, summary, title）
- ✅ 支持可选的 `tasks` 字段
- ✅ 支持可选的 `startDate` 字段

**使用方式：**
```typescript
PATCH /api/itinerary/:id/from-frontend-data
{
  "itineraryData": { ... },  // 完整的前端数据
  "startDate": "2025-11-24", // 可选
  "tasks": [...]             // 可选
}
```

**注意：** 这个接口会完全替换现有的 days 和 activities 数据。

---

### 3. ✅ POST /api/v1/itineraries (创建行程模版)

**兼容性：完全兼容**

- ✅ 支持顶层格式（title, destination, duration 等）
- ✅ 支持 `itineraryData` 嵌套格式（会自动提取）
- ✅ 支持 `itineraryData.days` 数组（包含 `day` 序号、`date`、`timeSlots`）
- ✅ 支持 `itineraryData.preferences` 数组格式
- ✅ 支持 `itineraryData.recommendations` 对象
- ✅ 支持 `itineraryData.totalCost`, `summary`, `title`
- ✅ 支持可选的 `tasks` 字段

**使用方式：**
```typescript
// 方式1：顶层格式
POST /api/v1/itineraries
{
  "title": "冰岛之旅",
  "destination": "冰岛",
  "duration": 5,
  "days": [...],
  ...
}

// 方式2：嵌套格式（前端数据）
POST /api/v1/itineraries
{
  "itineraryData": { ... },  // 完整的前端数据
  "tasks": [...]             // 可选
}
```

---

### 4. ✅ PUT /api/v1/itineraries/:id (更新行程模版)

**兼容性：完全兼容**

- ✅ `UpdateItineraryTemplateDto` 继承自 `CreateItineraryTemplateDto`，所有字段可选
- ✅ 支持 `itineraryData` 嵌套格式
- ✅ 支持更新 `days` 数组的详细内容
- ✅ 支持更新所有字段

**使用方式：**
```typescript
PUT /api/v1/itineraries/:id
{
  "itineraryData": { ... },  // 完整的前端数据
  "tasks": [...]             // 可选
}
```

---

## 问题总结

### 主要问题

1. **更新行程接口不支持完整数据更新**
   - `PATCH /api/itinerary/:id` 只能更新简单字段
   - 无法更新 `days` 数组的详细内容（activities/timeSlots）
   - 无法使用前端的数据格式

2. **前端数据中的 `backendItineraryId` 无法使用**
   - 更新接口需要从 URL 路径获取 ID
   - 前端数据中的 `backendItineraryId` 会被忽略

### 解决方案

#### ✅ 已实现：创建新的更新接口

已创建新的接口，支持完整的前端数据格式：

```typescript
PATCH /api/itinerary/:id/from-frontend-data
{
  "itineraryData": { ... },  // 完整的前端数据
  "tasks": [...]             // 可选
  "startDate": "2025-11-24"  // 可选
}
```

**实现细节：**
- 在 `ItineraryRepository` 中添加了 `updateItineraryWithDays` 方法
- 在 `ItineraryService` 中添加了 `updateItineraryFromFrontendData` 方法
- 在 `ItineraryController` 中添加了新的路由处理

**注意：** 这个接口会完全替换现有的 days 和 activities 数据（先删除再创建）。

#### 方案2：使用行程模版接口

如果前端数据主要用于创建/更新行程模版，可以使用：
- `POST /api/v1/itineraries` - 创建
- `PUT /api/v1/itineraries/:id` - 更新

---

## 字段映射检查

### ✅ 完全匹配的字段

| 前端字段 | 后端字段 | 状态 |
|---------|---------|------|
| `itineraryData.destination` | `destination` | ✅ |
| `itineraryData.duration` | `duration` / `days` | ✅ |
| `itineraryData.budget` | `budget` | ✅ |
| `itineraryData.preferences` | `preferences` | ✅ (数组自动转换) |
| `itineraryData.travelStyle` | `travelStyle` | ✅ |
| `itineraryData.days` | `days` | ✅ |
| `itineraryData.totalCost` | `totalCost` | ✅ |
| `itineraryData.summary` | `summary` | ✅ |
| `itineraryData.title` | `title` | ✅ |
| `itineraryData.recommendations` | `recommendations` | ✅ |

### ✅ days 字段映射

| 前端字段 | 后端字段 | 状态 |
|---------|---------|------|
| `days[].day` | `days[].day` (天数序号) | ✅ |
| `days[].date` | `days[].date` | ✅ |
| `days[].title` | `days[].title` (可选) | ✅ |
| `days[].summary` | `days[].summary` (可选) | ✅ |
| `days[].timeSlots` | `days[].activities` | ✅ |

### ✅ timeSlots 字段映射

| 前端字段 | 后端字段 | 状态 |
|---------|---------|------|
| `timeSlots[].time` | `activities[].time` | ✅ |
| `timeSlots[].title` | `activities[].title` | ✅ |
| `timeSlots[].activity` | `activities[].title` (备用) | ✅ |
| `timeSlots[].type` | `activities[].type` | ✅ |
| `timeSlots[].coordinates` | `activities[].location` | ✅ |
| `timeSlots[].notes` | `activities[].notes` | ✅ |
| `timeSlots[].cost` | `activities[].cost` | ✅ |
| `timeSlots[].duration` | `activities[].duration` | ✅ |
| `timeSlots[].details` | 不保存（仅用于前端展示） | ⚠️ |

### ⚠️ 需要注意的字段

1. **`itineraryData.itinerary`** - 空数组，会被忽略（正确）
2. **`timeSlots[].details`** - 包含大量详细信息，当前不保存到数据库（可能需要保存到 `detailsJson` 字段）
3. **`backendItineraryId`** - 仅用于前端标识，更新时需要从 URL 路径获取 ID

---

## 建议

1. **创建新接口**：`PATCH /api/itinerary/:id/from-frontend-data` 用于更新完整行程数据
2. **或者扩展现有接口**：让 `PATCH /api/itinerary/:id` 支持 `itineraryData` 字段
3. **保存 details 字段**：考虑将 `timeSlots[].details` 保存到数据库的 `detailsJson` 字段中

