# 行程创建接口 - 前端数据格式

## 概述

此接口接受前端提供的完整行程数据格式（包含 `itineraryData` 和 `tasks`），自动转换为标准格式并创建行程。

## 接口信息

**接口路径：** `POST /api/itinerary/from-frontend-data`

**认证：** 需要 JWT Token（Bearer Token）

**Content-Type：** `application/json`

## 请求参数

### 请求体结构

```typescript
{
  itineraryData: {
    destination: string;        // 目的地，必填
    duration: number;           // 行程天数，必填
    title: string;              // 行程标题，必填
    budget?: string;            // 预算（可选）
    preferences?: string[];     // 偏好数组（可选）
    travelStyle?: string;       // 旅行风格（可选）
    itinerary?: any[];          // 行程数组（可选，通常为空）
    recommendations?: {        // 推荐信息（可选）
      accommodation?: string;
      transportation?: string;
      food?: string;
      tips?: string;
    };
    days: Array<{              // 天数详情，必填
      day: number;             // 天数序号（从1开始）
      date: string;            // 日期（YYYY-MM-DD格式）
      timeSlots: Array<{       // 时间段列表
        time: string;          // 时间（HH:mm格式）
        title?: string;        // 标题
        activity?: string;     // 活动名称
        type?: string;         // 类型：attraction/meal/hotel/shopping/transport
        coordinates?: {        // 坐标
          lat: number;
          lng: number;
        };
        notes?: string;        // 备注
        duration?: number;      // 持续时间（分钟）
        cost?: number;         // 成本
        details?: object;      // 详细信息（JSON对象，**会被保存到数据库**），包含多语言名称、地址、开放时间、价格详情、推荐信息等
      }>;
    }>;
    totalCost?: number;        // 总成本（可选）
    summary?: string;          // 摘要（可选）
    practicalInfo?: {          // 实用信息（可选）
      weather?: string;        // 未来一周天气预报摘要
      safety?: string;        // 安全提醒和注意事项
      plugType?: string;      // 当地插座类型和电压
      currency?: string;      // 当地货币及汇率
      culturalTaboos?: string; // 文化禁忌和注意事项
      packingList?: string;   // 针对性打包清单
    };
  };
  tasks?: Array<{              // 任务列表（可选）
    id?: string;
    title: string;
    completed?: boolean;
    createdAt?: number;
    autoGenerated?: boolean;
    autoKey?: string;
    category?: string;
    destination?: string;
    links?: Array<{
      label: string;
      url: string;
    }>;
  }>;
  startDate?: string;          // 旅行开始日期（可选，如果不提供则使用第一天的日期）
}
```

### 字段说明

#### itineraryData

| 字段名 | 类型 | 必填 | 说明 |
|--------|------|------|------|
| destination | string | 是 | 目的地名称 |
| duration | number | 是 | 行程天数（1-30） |
| title | string | 是 | 行程标题 |
| budget | string | 否 | 预算等级（low/medium/high/economy/comfort/luxury） |
| preferences | string[] | 否 | 用户偏好数组 |
| travelStyle | string | 否 | 旅行风格（relaxed/moderate/intensive） |
| days | Array | 是 | 天数详情数组 |
| totalCost | number | 否 | 总成本 |
| summary | string | 否 | 行程摘要 |
| practicalInfo | object | 否 | 实用信息（天气、安全、插座、汇率、文化禁忌、打包清单等） |

#### days 数组项

| 字段名 | 类型 | 必填 | 说明 |
|--------|------|------|------|
| day | number | 是 | 天数序号（从1开始） |
| date | string | 是 | 日期（YYYY-MM-DD格式） |
| timeSlots | Array | 是 | 时间段列表 |

#### timeSlots 数组项

| 字段名 | 类型 | 必填 | 说明 |
|--------|------|------|------|
| time | string | 是 | 时间（HH:mm格式） |
| title | string | 否 | 标题（如果未提供，将使用 activity） |
| activity | string | 否 | 活动名称 |
| type | string | 否 | 类型：attraction/meal/hotel/shopping/transport（默认：attraction） |
| coordinates | object | 否 | 坐标 {lat: number, lng: number} |
| notes | string | 否 | 备注 |
| duration | number | 否 | 持续时间（分钟，默认：60） |
| cost | number | 否 | 成本（默认：0） |
| details | object | 否 | 详细信息（JSON对象，**会被保存到数据库**），包含多语言名称、地址、开放时间、价格详情、推荐信息等 |

#### tasks 数组项（可选）

| 字段名 | 类型 | 必填 | 说明 |
|--------|------|------|------|
| id | string | 否 | 任务ID |
| title | string | 是 | 任务标题 |
| completed | boolean | 否 | 是否完成（默认：false） |
| createdAt | number | 否 | 创建时间（时间戳） |
| autoGenerated | boolean | 否 | 是否自动生成 |
| autoKey | string | 否 | 自动生成键 |
| category | string | 否 | 任务类别 |
| destination | string | 否 | 目的地 |
| links | Array | 否 | 相关链接列表 |

## 响应数据

### 成功响应

**状态码：** `200 OK`

```json
{
  "success": true,
  "data": {
    "id": "uuid",
    "destination": "冰岛",
    "startDate": "2025-11-21",
    "daysCount": 5,
    "summary": "这个5天冰岛行程覆盖...",
    "totalCost": 2000,
    "days": [
      {
        "day": 1,
        "date": "2025-11-21",
        "activities": [
          {
            "time": "08:00",
            "title": "翱翔冰岛之翼：抵达雷克雅未克",
            "type": "transport",
            "duration": 60,
            "location": {
              "lat": 64.1283,
              "lng": -21.8278
            },
            "notes": "从机场乘坐巴士或出租车前往市区...",
            "cost": 50
          }
        ]
      }
    ],
    "preferences": {
      "interests": [],
      "budget": "medium",
      "travelStyle": "moderate"
    },
    "status": "draft",
    "createdAt": "2025-01-20T10:00:00Z",
    "updatedAt": "2025-01-20T10:00:00Z"
  }
}
```

### 错误响应

**状态码：** `400 Bad Request`

```json
{
  "success": false,
  "error": "缺少开始日期：请提供 startDate 或确保 days 数组的第一天包含 date 字段"
}
```

## 数据转换说明

接口会自动进行以下转换：

1. **timeSlots → activities**：将 `timeSlots` 数组转换为 `activities` 数组
2. **字段映射**：
   - `timeSlot.title` 或 `timeSlot.activity` → `activity.title`
   - `timeSlot.coordinates` → `activity.location`
   - `timeSlot.type` → `activity.type`（如果未提供，默认为 `attraction`）
   - `timeSlot.duration` → `activity.duration`（如果未提供，默认为 60 分钟）
   - `timeSlot.cost` → `activity.cost`（如果未提供，默认为 0）
   - `timeSlot.details` → `activity.details`（**会被保存到数据库的 JSONB 字段**）
3. **preferences 转换**：
   - `budget` 字符串映射：`economy` → `low`，`comfort` → `medium`，`luxury` → `high`
   - `travelStyle` 字符串映射：保持不变
   - `preferences` 数组 → `preferences.interests`
4. **开始日期**：优先使用传入的 `startDate`，否则使用 `days[0].date`

## 使用示例

### 请求示例

```bash
curl -X POST https://api.example.com/api/itinerary/from-frontend-data \
  -H "Authorization: Bearer YOUR_JWT_TOKEN" \
  -H "Content-Type: application/json" \
  -d '{
    "itineraryData": {
      "destination": "冰岛",
      "duration": 5,
      "title": "冰岛之旅",
      "budget": "medium",
      "preferences": [],
      "travelStyle": "moderate",
      "days": [
        {
          "day": 1,
          "date": "2025-11-21",
          "timeSlots": [
            {
              "time": "08:00",
              "title": "翱翔冰岛之翼：抵达雷克雅未克",
              "activity": "翱翔冰岛之翼：抵达雷克雅未克",
              "type": "transport",
              "coordinates": {
                "lat": 64.1283,
                "lng": -21.8278
              },
              "notes": "从机场乘坐巴士或出租车前往市区...",
              "cost": 50,
              "duration": 60
            }
          ]
        }
      ],
      "totalCost": 2000,
      "summary": "这个5天冰岛行程覆盖...",
      "practicalInfo": {
        "weather": "未来一周以晴天为主，气温15-25°C",
        "safety": "冰岛整体安全状况良好",
        "plugType": "Type C/F，220V，50Hz",
        "currency": "ISK（冰岛克朗），1 ISK ≈ 0.05 CNY",
        "culturalTaboos": "进入教堂需保持安静",
        "packingList": "轻便外套、防滑徒步鞋、防晒用品"
      }
    },
    "tasks": [
      {
        "title": "确认护照有效期及前往 冰岛 是否需要签证/入境许可。",
        "completed": false,
        "category": "preparation",
        "destination": "冰岛"
      }
    ]
  }'
```

### JavaScript/TypeScript 示例

```typescript
const response = await fetch('/api/itinerary/from-frontend-data', {
  method: 'POST',
  headers: {
    'Authorization': `Bearer ${token}`,
    'Content-Type': 'application/json',
  },
  body: JSON.stringify({
    itineraryData: {
      destination: '冰岛',
      duration: 5,
      title: '冰岛之旅',
      budget: 'medium',
      preferences: [],
      travelStyle: 'moderate',
      days: [
        {
          day: 1,
          date: '2025-11-21',
          timeSlots: [
            {
              time: '08:00',
              title: '翱翔冰岛之翼：抵达雷克雅未克',
              type: 'transport',
              coordinates: { lat: 64.1283, lng: -21.8278 },
              notes: '从机场乘坐巴士或出租车前往市区...',
              cost: 50,
              duration: 60,
            },
          ],
        },
      ],
      totalCost: 2000,
      summary: '这个5天冰岛行程覆盖...',
    },
    tasks: [
      {
        title: '确认护照有效期及前往 冰岛 是否需要签证/入境许可。',
        completed: false,
        category: 'preparation',
        destination: '冰岛',
      },
    ],
  }),
});

const result = await response.json();
```

## 注意事项

1. **日期格式**：所有日期字段必须使用 `YYYY-MM-DD` 格式
2. **时间格式**：时间字段必须使用 `HH:mm` 格式
3. **坐标**：如果未提供 `coordinates`，`location` 将默认为 `{lat: 0, lng: 0}`
4. **类型映射**：`type` 字段必须是以下之一：`attraction`、`meal`、`hotel`、`shopping`、`transport`
5. **任务处理**：目前 `tasks` 数组会被接收但不会保存到数据库，仅用于日志记录。如果需要保存任务，请使用任务管理接口
6. **开始日期**：如果不提供 `startDate`，系统将使用 `days[0].date` 作为开始日期
7. **details 字段**：`timeSlots` 中的 `details` 字段**会被保存到数据库**，用于存储活动的详细信息（多语言名称、地址、开放时间、价格详情、推荐信息等）

8. **practicalInfo 字段**：`itineraryData` 中的 `practicalInfo` 字段**会被保存到数据库**，用于存储行程的实用信息（天气、安全、插座、汇率、文化禁忌、打包清单等）

## 相关接口

- `POST /api/itinerary` - 使用标准格式创建行程
- `POST /api/itinerary/generate` - 生成行程
- `GET /api/itinerary` - 获取行程列表
- `GET /api/itinerary/:id` - 获取行程详情
- `PATCH /api/itinerary/:id` - 更新行程
- `DELETE /api/itinerary/:id` - 删除行程

