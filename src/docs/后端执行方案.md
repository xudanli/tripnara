# 后端执行方案

## 1. 总体架构

- **语言/框架**：Node.js + NestJS（或 Express + TypeScript）；也可选 Go / Spring Boot，建议统一 TypeScript。
- **数据库**：PostgreSQL（推荐）或 MySQL，使用 Prisma / TypeORM 管理 Schema 与迁移。
- **缓存**：Redis（存放安全提示缓存、AI 请求限流状态、短期数据）。
- **消息队列（可选）**：BullMQ / RabbitMQ，用于行程生成的异步任务链。
- **部署**：Docker 镜像 + K8s/Serverless。网关/负载均衡前置，提供 REST/GraphQL API。
- **鉴权**：JWT + Refresh Token；可对接现有登录系统。

---

## 2. 核心服务模块

### 2.1 行程与模板服务 (`JourneyService`)
- CRUD：`journey_templates`, `journeys`, `journey_days`, `journey_time_slots`.
- 模板复制：将模板结构拷贝成行程实例。
- 版本管理/自动保存（可记录 `journey_versions`）。
- 任务列表同步：合并 `tasks_default` 与 AI 生成任务。

### 2.2 AI 调用代理 (`AIOrchestrator`)
- 统一封装 DeepSeek/OpenAI 调用。
- Prompt 管理与 JSON Schema 校验。
- 限流/熔断、Token 统计、错误重试。
- 写入 `ai_request_logs`, `ai_generation_jobs`，缓存安全提示 (`ai_safety_notice_cache`).

### 2.3 外部 API 聚合 (`ExternalAPIService`)
- Mapbox：距離/时间、地理编码，缓存结果。
- Eventbrite/活动、天气、签证接口。
- 图片服务（Unsplash/Pexels）代理，避免 Key 暴露，带 CDN 缓存。
- 容错：时间超时、备用源。

### 2.4 行前任务与提醒 (`PreparationTaskService`)
- 根据目的地/模板/LLM 返回任务数组。
- 管理任务库（`preparation_profiles`），支持后台配置。
- 跟 AI 结果合并去重。

### 2.5 安全提示与风险控 (`SafetyNoticeService`)
- 接收生成请求，先查缓存（dest+lang+summary hash）。
- 若无缓存，调用 AI 生成、落库，统一格式化。
- 可扩展地缘安全数据源。

### 2.6 用户日志与行为 (`JourneyActivityLog`)
- 记录用户编辑操作、分享、反馈。
- 提供 API 给前端查看历史/版本。

### 2.7 通知与推送（可选）
- 行程生成完成、任务提醒、安全通知。
- 通知表 + 消息队列 + 推送服务。

---

## 3. 数据层实现

- 按前文数据库设计创建迁移脚本：
  - 模板 (`journey_templates` 系列)
  - 行程 (`journeys` 系列)
  - AI 日志与缓存
  - 用户行为表
- 编写 Repository（Prisma/TypeORM）：提供事务、批量更新、软删除等。

---

## 4. API 接口规划（示例）

| 功能 | Method & Path | 说明 |
|------|---------------|------|
| 模板列表 | `GET /api/templates` | 支持筛选/分页 |
| 模板详情 | `GET /api/templates/:id` | 返回 days/slots |
| 新建模板 | `POST /api/templates` | 后台或运营使用 |
| 生成行程 | `POST /api/journeys` | 参数：模板 id / 用户偏好 |
| 行程详情 | `GET /api/journeys/:id` | 返回完整结构 |
| 更新行程 | `PATCH /api/journeys/:id` | 支持局部更新（JSON Patch） |
| 行程时段管理 | `POST /api/journeys/:id/slots` 等 | 增删改 |
| 生成安全提示 | `POST /api/journeys/:id/safety-notice` | 可队列异步 |
| 任务列表 | `GET /api/journeys/:id/tasks` / `PATCH` | 同步与更新 |
| AI 日志查询 | `GET /api/journeys/:id/ai-logs` | Debug/审计 |

> 生成流程可拆成：`POST /generate/framework` → `POST /generate/day-details` → `POST /generate/transport` … 或封装为 `POST /generate/full` 使用队列逐步执行。

---

## 5. 行程生成任务链

1. `POST /api/journeys` → 创建 `journey` (status=`pending`)
2. 入队 `journey_generation_queue`：
   - `frameworkGenerator`：写入 `journey_days` 基础结构
   - `dayDetailsGenerator`：填充 `time_slots`
   - `transportGenerator`：补交通信息 (`fetchTransportInsights`)
   - `tipsGenerator`：增添着装/文化建议
   - `scenicIntroGenerator`：景点描述
3. 每步落库 + 写 `ai_request_logs`
4. 全部完成后更新 `journeys.status = 'generated'`

> 队列实现：BullMQ，支持重试与监控；如需同步生成，可直接串行调用。

---

## 6. 缓存策略

- **Redis**：
  - 安全提示 (`ai_safety_notice_cache`)：Key=dest+lang+hash(summary)，TTL 7-30 天。
  - Mapbox 距离/逆地理编码缓存（Key=origin+dest+mode）。
  - 行程生成中间状态：避免重复触发。
- **数据库**：长期存储用于回查、分析。

---

## 7. 安全与合规

- 所有外部 API Key 放在后端（环境变量/密钥管理）。
- AI Prompt/Response 写入日志需脱敏（过滤个人信息）。
- 对用户输入的行程数据做 XSS/SQL 注入防护。
- 若存储用户行程较敏感，可考虑字段加密或按用户隔离。

---

## 8. DevOps & 测试

- **测试**：单元测试（Service 层），集成测试（API + DB + Mock 外部服务）。
- **CI/CD**：代码合并即跑 lint/test；镜像自动构建 → 部署。
- **监控**：APM（例如 Prometheus + Grafana）、日志（ELK/Sentry）、队列状态面板。
- **配置管理**：dotenv / Vault，区分开发/测试/生产环境。
- **错误处理**：统一 Error Filter/Interceptor，根据模块返回标准错误码。

---

## 9. 迭代路线（建议）

1. **首阶段**
   - 起 NestJS/Express 项目，接入 Postgres + Prisma
   - 实现模板 & 行程基础 CRUD
   - 搬迁安全提示生成到后端（含缓存）
   - 包装 DeepSeek/OpenAI 调用

2. **第二阶段**
   - 完整行程生成链（框架 → 日程 → 交通 → Tips）
   - Mapbox/活动等外部 API 代理 + 缓存
   - 准备任务服务

3. **第三阶段**
   - 行程协作/分享、通知与队列优化
   - 指标统计、成本监控、后台管理界面（可选）

4. **运维完善**
   - 加入消息队列、Redis、监控体系
   - 编写风控（频率限制、IP 黑名单等）

---

通过上述执行方案，可将关键功能（AI 调用、数据存储、模板维护、外部 API 聚合）稳固在后端，前端只需消费标准化接口，整体安全性与可扩展性显著提升。若需详细 DDL、代码骨架或部署脚本，可在此基础上继续提供。